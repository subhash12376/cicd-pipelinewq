pipeline{
    agent any

    environment {
        CONTAINER_NAME = 'nestjs-app'
        IMAGE_NAME = 'nesths-image'
        EMAIL = 'johnantoneo9@gmail.com'
        PORT = '3000'
           }
           
           stages{
            stage('clone repo'){
                steps{
                    git branch: 'main', url: 'https://github.com/subhash12376/cicd-pipelinewq.git'
                }
            }
           
                stage('Build Docker Image') {
                    steps {
                           sh 'docker build -t $IMAGE_NAME . '
                        }
                }
                stage('stop & remove Previous container'){
                    steps{
                    sh '''
                        docker stop $CONTAINER_NAME || true
                        docker rm $CONTAINER_NAME || true
                    ''' 
            
           }
                stage('Docker Container Run') {
                    steps {
                        sh '''
                            docker run -d --name $CONTAINER_NAME -p $PORT:$PORT $IMAGE_NAME
                        '''
                    }
                }
                stage('Send Notification') {
                    steps {
                        script {
                            def message = "Docker container $CONTAINER_NAME is running on port $PORT"
                            sh "echo '$message' | mail -s 'Docker Notification' $EMAIL"
                        }
                    }
                }
                stage('email notification') {
                    steps {
                       emailext(
                        subject: "Docker Container Notification",
                        body: "The Docker container $CONTAINER_NAME has been successfully deployed and is running on port $PORT.
                        http://54.167.34.0:${PORT}/",
                        to: "${EMAIL}",
            
                       )
                    }
                }
           }

}